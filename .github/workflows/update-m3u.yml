name: Update M3U Playlist

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨è¿è¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - '.github/workflows/update-m3u.yml'  # å½“å·¥ä½œæµæ–‡ä»¶æ›´æ”¹æ—¶è§¦å‘

permissions:
  contents: write  # æˆäºˆå†™å…¥ä»“åº“å†…å®¹çš„æƒé™

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        
    - name: Download M3U playlist
      run: |
        echo "æ­£åœ¨ä¸‹è½½M3Uæ’­æ”¾åˆ—è¡¨..."
        echo "URL: https://iptv.catvod.com/tv.m3u"
        
        # æ·»åŠ æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯å’Œé‡è¯•æœºåˆ¶
        curl -L -v \
          --max-time 30 \
          --retry 3 \
          --retry-delay 5 \
          --retry-max-time 60 \
          -o "tv.m3u" \
          "https://iptv.catvod.com/tv.m3u" 2>&1 | tee curl_output.log
        
        echo "=== curlé€€å‡ºçŠ¶æ€ç : $? ==="
        echo "=== ä¸‹è½½çš„æ–‡ä»¶ä¿¡æ¯ ==="
        ls -la tv.m3u 2>/dev/null || echo "æ–‡ä»¶ä¸å­˜åœ¨"
        
        if [ -f "tv.m3u" ]; then
          echo "=== æ–‡ä»¶å†…å®¹å‰20è¡Œ ==="
          head -20 tv.m3u
          echo "=== æ–‡ä»¶å¤§å°å’Œè¡Œæ•° ==="
          wc -l tv.m3u
          echo "å­—èŠ‚æ•°: $(wc -c < tv.m3u)"
        else
          echo "é”™è¯¯ï¼šä¸‹è½½çš„æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Check M3U content
      run: |
        echo "æ£€æŸ¥M3Uæ–‡ä»¶å†…å®¹..."
        if [ ! -f "tv.m3u" ]; then
          echo "âŒ é”™è¯¯ï¼štv.m3u æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        if [ ! -s "tv.m3u" ]; then
          echo "âŒ é”™è¯¯ï¼štv.m3u æ–‡ä»¶ä¸ºç©º"
          echo "æ–‡ä»¶å¤§å°: $(stat -c%s tv.m3u) bytes"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«M3Uå¤´éƒ¨
        if grep -q "^#EXTM3U" tv.m3u; then
          echo "âœ… æ–‡ä»¶åŒ…å«æœ‰æ•ˆçš„M3Uå¤´éƒ¨"
          echo "M3Uå¤´éƒ¨è¡Œ:"
          grep "^#EXTM3U" tv.m3u
        else
          echo "âš ï¸  è­¦å‘Šï¼šæ–‡ä»¶ä¸åŒ…å«æ ‡å‡†çš„M3Uå¤´éƒ¨"
          echo "æ–‡ä»¶å¤´éƒ¨å†…å®¹:"
          head -5 tv.m3u
        fi
        
        # ç»Ÿè®¡ä¿¡æ¯
        echo "=== æ–‡ä»¶ç»Ÿè®¡ ==="
        echo "æ€»è¡Œæ•°: $(wc -l < tv.m3u)"
        echo "åŒ…å«#EXTINFçš„è¡Œæ•°: $(grep -c "^#EXTINF" tv.m3u)"
        echo "åŒ…å«http://çš„è¡Œæ•°: $(grep -c "http://" tv.m3u)"
        echo "åŒ…å«https://çš„è¡Œæ•°: $(grep -c "https://" tv.m3u)"
        
    - name: Set file permissions
      run: |
        echo "è®¾ç½®æ–‡ä»¶æƒé™..."
        chmod 644 tv.m3u
        echo "æƒé™è®¾ç½®å®Œæˆ:"
        ls -la tv.m3u
        
    - name: Check for changes
      id: check_changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ”¹..."
        # å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "tv.m3u" ]; then
          echo "âŒ é”™è¯¯ï¼štv.m3u æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # è·å–æ–‡ä»¶å“ˆå¸Œè¿›è¡Œæ¯”è¾ƒ
        new_hash=$(md5sum tv.m3u | cut -d' ' -f1)
        echo "æ–°æ–‡ä»¶MD5: $new_hash"
        
        # æ£€æŸ¥æ—§æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶è·å–å“ˆå¸Œ
        if [ -f "tv.m3u" ]; then
          old_hash=""
          if git diff --name-only HEAD~1 HEAD | grep -q "tv.m3u"; then
            old_hash=$(git show HEAD:tv.m3u 2>/dev/null | md5sum | cut -d' ' -f1) || old_hash=""
          fi
          echo "æ—§æ–‡ä»¶MD5: $old_hash"
          
          if [ "$new_hash" = "$old_hash" ]; then
            echo "æ–‡ä»¶æœªæ›´æ”¹"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "æ–‡ä»¶å·²æ›´æ”¹"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "é¦–æ¬¡åˆ›å»ºæ–‡ä»¶"
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push if changed
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        echo "æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
        
        # é…ç½®Git
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ·»åŠ æ–‡ä»¶
        git add tv.m3u
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è¦æäº¤çš„å†…å®¹
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ’­æ”¾åˆ—è¡¨ $(date +'%Y-%m-%d %H:%M:%S') UTC"
        
        # æ¨é€æ›´æ”¹
        git push
        
        echo "âœ… æ’­æ”¾åˆ—è¡¨å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
        
    - name: No changes detected
      if: steps.check_changes.outputs.changed == 'false'
      run: |
        echo "â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
        
    - name: Create summary
      if: always()
      run: |
        echo "## M3Uæ’­æ”¾åˆ—è¡¨æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è¿è¡Œæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**æºæ–‡ä»¶URL:** [https://iptv.catvod.com/tv.m3u](https://iptv.catvod.com/tv.m3u)" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "tv.m3u" ]; then
          file_size=$(stat -c%s tv.m3u)
          line_count=$(wc -l < tv.m3u)
          extinf_count=$(grep -c "^#EXTINF" tv.m3u 2>/dev/null || echo "0")
          
          echo "**æ–‡ä»¶çŠ¶æ€:** âœ… ä¸‹è½½æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "**æ–‡ä»¶å¤§å°:** $file_size å­—èŠ‚" >> $GITHUB_STEP_SUMMARY
          echo "**æ€»è¡Œæ•°:** $line_count è¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "**é¢‘é“æ•°é‡:** $extinf_count ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "**æœ€åä¿®æ”¹:** $(date -r tv.m3u -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæ–‡ä»¶å‰å‡ è¡Œ
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ–‡ä»¶é¢„è§ˆ:**" >> $GITHUB_STEP_SUMMARY
          echo '```m3u' >> $GITHUB_STEP_SUMMARY
          head -10 tv.m3u >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
        else
          echo "**æ–‡ä»¶çŠ¶æ€:** âŒ ä¸‹è½½å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ·»åŠ æ›´æ”¹çŠ¶æ€
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check_changes.outputs.changed }}" = "true" ]; then
          echo "**ä»“åº“çŠ¶æ€:** ğŸ”„ å·²æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ steps.check_changes.outputs.changed }}" = "false" ]; then
          echo "**ä»“åº“çŠ¶æ€:** â¸ï¸  æ— æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "**ä»“åº“çŠ¶æ€:** â“ æœªçŸ¥" >> $GITHUB_STEP_SUMMARY
        fi

name: Update M3U Playlist

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨è¿è¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - '.github/workflows/update-m3u.yml'  # å½“å·¥ä½œæµæ–‡ä»¶æ›´æ”¹æ—¶è§¦å‘

permissions:
  contents: write  # æˆäºˆå†™å…¥ä»“åº“å†…å®¹çš„æƒé™

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download M3U playlist
      run: |
        echo "æ­£åœ¨ä¸‹è½½M3Uæ’­æ”¾åˆ—è¡¨..."
        curl -L -o "tv.m3u" "https://iptv.catvod.com/tv.m3u"
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸‹è½½
        if [ -s "tv.m3u" ]; then
          echo "æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¤§å°ä¸º: $(wc -l < tv.m3u) è¡Œ"
          echo "æ–‡ä»¶å‰10è¡Œå†…å®¹:"
          head -10 tv.m3u
        else
          echo "é”™è¯¯ï¼šä¸‹è½½çš„æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Validate M3U format
      run: |
        echo "éªŒè¯M3Uæ–‡ä»¶æ ¼å¼..."
        if grep -q "^#EXTM3U" tv.m3u; then
          echo "âœ“ æ–‡ä»¶åŒ…å«æœ‰æ•ˆçš„M3Uå¤´éƒ¨"
        else
          echo "è­¦å‘Šï¼šæ–‡ä»¶å¯èƒ½ä¸æ˜¯æ ‡å‡†çš„M3Uæ ¼å¼"
        fi
        
    - name: Set file permissions
      run: |
        echo "è®¾ç½®æ–‡ä»¶æƒé™..."
        chmod 644 tv.m3u  # è®¾ç½®è¯»å†™æƒé™ï¼šæ‰€æœ‰è€…è¯»å†™ï¼Œå…¶ä»–ç”¨æˆ·åªè¯»
        ls -la tv.m3u
        
    - name: Commit and push if changed
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ”¹..."
        if git diff --quiet tv.m3u; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
        else
          echo "æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
          
          # é…ç½®Git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æäº¤æ›´æ”¹
          git add tv.m3u
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ’­æ”¾åˆ—è¡¨ $(date +'%Y-%m-%d %H:%M:%S')"
          
          # æ¨é€æ›´æ”¹
          git push
          
          echo "âœ… æ’­æ”¾åˆ—è¡¨å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
        fi
        
    - name: Create summary
      if: always()
      run: |
        echo "## M3Uæ’­æ”¾åˆ—è¡¨æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **æºæ–‡ä»¶URL:** https://iptv.catvod.com/tv.m3u" >> $GITHUB_STEP_SUMMARY
        if [ -f "tv.m3u" ]; then
          echo "- **æœ¬åœ°æ–‡ä»¶å¤§å°:** $(stat -c%s tv.m3u) bytes" >> $GITHUB_STEP_SUMMARY
          echo "- **è¡Œæ•°:** $(wc -l < tv.m3u)" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ€åä¿®æ”¹æ—¶é—´:** $(stat -c%y tv.m3u)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **çŠ¶æ€:** âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
